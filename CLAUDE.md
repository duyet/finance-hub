# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Finance Hub is a serverless Personal Finance Management (PFM) application built for the Vietnamese market with bilingual support (English/Vietnamese). It runs entirely on the Cloudflare Edge using React Router v7, D1 database, and Workers AI.

**Core Tech Stack:**
- **Framework:** React Router v7 (SSR, file-based routing)
- **Runtime:** Cloudflare Workers (edge computing)
- **Database:** Cloudflare D1 (SQLite)
- **Storage:** Cloudflare R2 (receipts/images)
- **Package Manager:** Bun (or npm)
- **Language:** TypeScript (strict mode)

## Development Commands

```bash
# Start development server
bun run dev
# or
npm run dev

# Type checking (REQUIRED before commits)
bun run typecheck

# Linting
bun run lint

# Run tests
bun run test

# Build for production
bun run build

# Deploy to Cloudflare Pages
bun run deploy

# Database migrations (local)
wrangler d1 migrations apply finance-hub --local

# Database migrations (production)
wrangler d1 migrations apply finance-hub --remote
```

**Important:** Always run `bun run typecheck` before committing. It runs `react-router typegen` to generate route types, then `tsc` to check for errors.

## Architecture

### Route-Based Architecture

The app uses React Router v7's manual route configuration (`app/routes.ts`). Routes are defined explicitly rather than auto-discovered.

**Route naming patterns:**
- `_index.tsx` → Index route (e.g., `/dashboard`)
- `.$id.tsx` → Dynamic parameter (e.g., `/transactions/:id`)
- `.new.tsx` → Create new resource (e.g., `/accounts/new`)
- `action.*.ts` → Action-only routes (no UI, form handlers)

**Protected routes:** Use `await requireAuth(request)` at the start of loaders/actions.

### Database Access Pattern

All database operations go through typed CRUD objects in `app/lib/db/*.server.ts`:

```typescript
import { getDb } from "~/lib/auth/db.server";
import { transactionsCrud } from "~/lib/db/transactions.server";

export async function loader({ request }: LoaderFunctionArgs) {
  const { user } = await requireAuth(request);
  const db = getDb(request);

  const transactions = await transactionsCrud.getAll(db, user.id);
  return { transactions };
}
```

**Key pattern:** The `db` instance is obtained from the request context, not directly imported.

### Cloudflare Bindings

Environment bindings are defined in `app/lib/auth/db.server.ts`:

```typescript
interface Env {
  DB: D1Database;
  AI?: Fetcher;
  CACHE?: KVNamespace;
  QUEUE?: Queue<unknown>;
  RECEIPTS_BUCKET?: R2Bucket;
}
```

Access via `getDb(request)` for database, or via `request.context.cloudflare.env` for other bindings.

### Component Organization

- **UI Primitives:** `app/components/ui/` - Shadcn/Radix components (button, dialog, select, etc.)
- **Feature Components:** Grouped by domain (dashboard, transactions, categories, import)
- **Layout Components:** `app/components/layout/` (Sidebar, Header)

Use lazy loading for code splitting on large components:
```typescript
const NetWorthCard = lazy(() => import("~/components/dashboard").then(m => ({ default: m.NetWorthCard })));
```

### Authentication

OAuth-only authentication using Arctic + Oslo:
- Providers: GitHub, Google
- Session-based with secure cookies
- `requireAuth(request)` returns `{ user, session }`
- User ID must be passed to all database queries

### i18n System

Custom i18n implementation (not react-i18next library):
- **Locales:** English (en), Vietnamese (vi)
- **Server-side:** Locale from `Accept-Language` header or cookie
- **Client-side:** `useI18n()` hook for translations
- **Translation files:** `public/locales/{en,vi}/common.json`

**Key differences:**
- VND currency: `1.234.567 ₫` (dots for thousands)
- USD currency: `$1,234.57` (commas for thousands)
- Dates: VI uses DD/MM/YYYY, EN uses MM/DD/YYYY

## Database Schema

**Core tables:**
- `users` - User accounts with OAuth
- `sessions` - Session management with expiration
- `financial_accounts` - Polymorphic account table (CHECKING, SAVINGS, CREDIT_CARD, LOAN, WALLET, INVESTMENT)
- `categories` - Income/expense categories with budgets
- `transactions` - Core transaction ledger

**Patterns:**
- Soft deletes via `is_archived` flag
- `user_id` column on all user-specific tables
- Cascade deletes for foreign keys
- Compound indexes for dashboard queries

## Path Aliases

```typescript
"@/*" → "./app/*"
"~/*" → "./app/*"
```

Both resolve to the `app/` directory. Use `~` for consistency.

## Type System

- **Server types:** Defined inline in `.server.ts` files
- **Shared types:** `*.types.ts` files (e.g., `transactions.types.ts`)
- **Validation:** Zod schemas in `app/lib/validations/`
- **Route types:** Generated by `react-router typegen`

Use `z.coerce` for URL parameter type coercion:
```typescript
export const transactionQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
});
```

## AI Integration

Cloudflare Workers AI (no API keys needed):
- **OCR:** Gemma 3 12B for receipt scanning
- **Chat:** Llama 3.1 8B for financial insights
- **Categorization:** Vector embeddings for auto-categorization

AI bindings are optional - check for existence before use.

## Security

- All server-only code MUST use `.server.ts` suffix
- Never commit `.dev.vars` or environment variables
- Use prepared statements with parameter binding (SQL injection prevention)
- CSP headers configured in `app/root.tsx`

## Testing

- **Unit tests:** Vitest (`app/__tests__/`)
- **E2E tests:** Playwright in `e2e/` directory
- Tests run against production URL

## Known Issues

- 186 ESLint warnings (mostly `any` types), 0 errors
- Queues disabled (requires paid Cloudflare plan)
- Migrations use SQLite syntax (D1-specific)

## Deployment

Cloudflare Pages with automatic deployment from `main` branch via GitHub Actions. No traditional server - all logic runs at the edge.
